<!doctype html>
<html>
<style>
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
    border: none;
    -webkit-text-size-adjust: 100%;
    background: transparent;
  }

  .discovery {
    height: 100vh;
    width: 100vw;
  }
</style>

<body>
  <script>
    let hostDataResolve = null
    let hostId = null
    window.JSON_DISCOVERY_DATA = ''
    async function sendData(data) {
      window.JSON_DISCOVERY_DATA = data
      if (!hostId) {
        hostDataResolve = new Promise((resolve) => {
          hostDataResolve = resolve
        })
      }
      let acceptToken = 'foo'
      window.postMessage({
        id: hostId,
        from: 'discoveryjs-app',
        type: 'startChunkedDataUpload',
        payload: {
          acceptToken
        }
      }, '*');
      window.postMessage({
        id: hostId,
        from: 'discoveryjs-app',
        type: 'dataChunk',
        payload: {
          acceptToken,
          value: data,
          done: true
        }
      }, '*');
    }

    window.addEventListener('message', (event) => {
      if (event.data.from === 'vscode-host') 
        sendData(event.data.data)
    });

    // Trick Discory for force enable in-page communication
    window.parent = {
      postMessage: (message) => {
        switch (message.type) {
          case 'ready': {
            hostId = message.id
            hostDataResolve?.()
          }
        }
        // console.log('discovery message', message)
      }
    }
  </script>
  <script type="module">
    import { initDiscovery } from '../json-discovery/build-chrome/discovery.js';

    const discovery = initDiscovery();
    discovery.action.define('getRaw', () => ({
      firstSliceText: window.JSON_DISCOVERY_DATA,
      firstSliceSize: window.JSON_DISCOVERY_DATA.length,
      fullSize: window.JSON_DISCOVERY_DATA.length
    }));
    discovery.action.define('getRawFull', () => ({
      json: window.JSON_DISCOVERY_DATA
    }))
    discovery.action.define('getSettings', () => ({
      expandLevel: 3,
      darkmode: 'auto',
      whatsnew: {}
    }))
    discovery.action.define('copyToClipboard', () => {
      navigator.clipboard.writeText(window.JSON_DISCOVERY_DATA)
    })
  </script>
</body>

</html>
